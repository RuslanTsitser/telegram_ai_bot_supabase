# Send Reminders Edge Function

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è Telegram –±–æ—Ç–∞ –æ –≤–æ–¥–µ –∏ –ø—Ä–∏–µ–º–∞—Ö –ø–∏—â–∏.

## –û–ø–∏—Å–∞–Ω–∏–µ

–≠—Ç–∞ Edge Function –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–º —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ Telegram Bot API. –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ —Ç–∏–ø–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π:

- **–í–æ–¥–∞** - –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞)
- **–ï–¥–∞** - –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–≤—Ç—Ä–∞–∫ –≤ 8:00)

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
pg_cron (–∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç)
    ‚Üì
Edge Function (send-reminders)
    ‚Üì
Telegram Bot API
    ‚Üì
–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞)
```

## –¢–∞–±–ª–∏—Ü—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### user_reminders

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `id` | UUID | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä |
| `telegram_user_id` | BIGINT | ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram |
| `reminder_type` | TEXT | –¢–∏–ø –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: 'water' –∏–ª–∏ 'meal' |
| `is_enabled` | BOOLEAN | –í–∫–ª—é—á–µ–Ω–æ –ª–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ |
| `reminder_time` | TIME | –í—Ä–µ–º—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (–¥–ª—è –µ–¥—ã) |
| `interval_minutes` | INTEGER | –ò–Ω—Ç–µ—Ä–≤–∞–ª –≤ –º–∏–Ω—É—Ç–∞—Ö (–¥–ª—è –≤–æ–¥—ã) |
| `last_sent_at` | TIMESTAMP | –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ |
| `timezone` | TEXT | –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |

### reminder_history

–ò—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π:

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `id` | UUID | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä |
| `telegram_user_id` | BIGINT | ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram |
| `reminder_type` | TEXT | –¢–∏–ø –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è |
| `sent_at` | TIMESTAMP | –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ |
| `status` | TEXT | –°—Ç–∞—Ç—É—Å: 'sent', 'failed', 'blocked' |
| `error_message` | TEXT | –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ |
| `reminder_id` | UUID | –°—Å—ã–ª–∫–∞ –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫—É –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è |

## –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (meal)

```typescript
// –ï—Å–ª–∏ –≤—Ä–µ–º—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —É–∂–µ –ø—Ä–æ—à–ª–æ —Å–µ–≥–æ–¥–Ω—è
if (now >= reminderDateTime) {
  // –ò –ø–æ—Å–ª–µ–¥–Ω–µ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –±—ã–ª–æ –Ω–µ —Å–µ–≥–æ–¥–Ω—è
  if (!lastSent || lastSent.toDateString() !== now.toDateString()) {
    return true; // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º
  }
}
```

### –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (water)

```typescript
// –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
if (!lastSent) return true;

// –ò–ª–∏ –µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏, —á–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª
const timeSinceLastSent = now.getTime() - lastSent.getTime();
const intervalMs = reminder.interval_minutes * 60 * 1000;
return timeSinceLastSent >= intervalMs;
```

## –°–æ–æ–±—â–µ–Ω–∏—è

### –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –≤–æ–¥–µ

- **–†—É—Å—Å–∫–∏–π:** "üíß –í—Ä–µ–º—è –ø–æ–ø–∏—Ç—å –≤–æ–¥—ã! –í–∞—à –æ—Ä–≥–∞–Ω–∏–∑–º –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏–∏."
- **–ê–Ω–≥–ª–∏–π—Å–∫–∏–π:** "üíß Time to drink water! Your body needs hydration."

### –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –µ–¥–µ

- **–†—É—Å—Å–∫–∏–π:** "üçΩÔ∏è –í—Ä–µ–º—è –ø–æ–µ—Å—Ç—å! –í–∞—à–µ–º—É –æ—Ä–≥–∞–Ω–∏–∑–º—É –Ω—É–∂–Ω–∞ —ç–Ω–µ—Ä–≥–∏—è."
- **–ê–Ω–≥–ª–∏–π—Å–∫–∏–π:** "üçΩÔ∏è Time to eat! Your body needs energy."

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è |
|------------|----------|--------------|
| `SUPABASE_URL` | URL –ø—Ä–æ–µ–∫—Ç–∞ Supabase | ‚úÖ |
| `SUPABASE_SERVICE_ROLE_KEY` | Service Role –∫–ª—é—á | ‚úÖ |
| `PRODUCTION_BOT_TOKEN` | –¢–æ–∫–µ–Ω Telegram –±–æ—Ç–∞ | ‚úÖ |

## –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ (pg_cron)

–§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç:

```sql
SELECT cron.schedule(
  'send-reminders-every-15-minutes',
  '*/15 * * * *', -- –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç
  'SELECT net.http_post(...)'
);
```

### –¢–æ—á–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏

- **–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞:** 0 –º–∏–Ω—É—Ç (–µ—Å–ª–∏ –≤—Ä–µ–º—è —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∑–∞–ø—É—Å–∫–æ–º cron)
- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞:** 14 –º–∏–Ω—É—Ç 59 —Å–µ–∫—É–Ω–¥

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°–æ–∑–¥–∞–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –≤–æ–¥–µ (–∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞)

```sql
INSERT INTO user_reminders (telegram_user_id, reminder_type, is_enabled, interval_minutes, timezone) 
VALUES (123456789, 'water', true, 120, 'UTC');
```

### –°–æ–∑–¥–∞–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –µ–¥–µ (–≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è)

```sql
INSERT INTO user_reminders (telegram_user_id, reminder_type, is_enabled, reminder_time, timezone) 
VALUES (123456789, 'meal', true, '13:00', 'UTC');
```

### –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —Ñ—É–Ω–∫—Ü–∏–∏

```sql
SELECT net.http_post(
  url := 'https://your-project.supabase.co/functions/v1/send-reminders',
  headers := jsonb_build_object(
    'Content-Type', 'application/json',
    'Authorization', 'Bearer YOUR_ANON_KEY'
  ),
  body := '{}'::jsonb,
  timeout_milliseconds := 30000
) as request_id;
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π

```sql
SELECT 
  telegram_user_id,
  reminder_type,
  sent_at,
  status,
  error_message
FROM reminder_history
WHERE telegram_user_id = 123456789
ORDER BY sent_at DESC;
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ pg_cron

```sql
SELECT 
  jobid,
  jobname,
  schedule,
  active,
  last_run
FROM cron.job 
WHERE jobname = 'send-reminders-every-15-minutes';
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

```sql
SELECT 
  *
FROM cron.job_run_details
WHERE jobid = (SELECT jobid FROM cron.job WHERE jobname = 'send-reminders-every-15-minutes')
ORDER BY start_time DESC
LIMIT 10;
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTP –æ—Ç–≤–µ—Ç–æ–≤

```sql
SELECT 
  id,
  status_code,
  content,
  error_msg,
  created
FROM net._http_response
ORDER BY created DESC
LIMIT 5;
```

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–ú–∞–∫—Å–∏–º—É–º 8 –∑–∞–¥–∞—á pg_cron** –º–æ–≥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
2. **–ö–∞–∂–¥–∞—è –∑–∞–¥–∞—á–∞ –Ω–µ –±–æ–ª–µ–µ 10 –º–∏–Ω—É—Ç** –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
3. **–¢–æ—á–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏** –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ pg_cron (15 –º–∏–Ω—É—Ç)
4. **–û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç RLS (Row Level Security) –¥–ª—è –∑–∞—â–∏—Ç—ã –¥–∞–Ω–Ω—ã—Ö
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
- Service Role –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –¥–∞–Ω–Ω—ã–º –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –í—Å–µ HTTP –∑–∞–ø—Ä–æ—Å—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è

## –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

```bash
# –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
supabase functions deploy send-reminders

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
supabase functions list
```

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ pg_cron –∞–∫—Ç–∏–≤–µ–Ω
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ Dashboard
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –≤ `reminder_history`

### –û—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏–π

### –ü—Ä–æ–±–ª–µ–º—ã —Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å pg_cron: `SELECT * FROM cron.job;`
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –∑–∞–¥–∞—á—É: `SELECT cron.alter_job(job_id, active := true);`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: `SELECT * FROM cron.job_run_details;`
