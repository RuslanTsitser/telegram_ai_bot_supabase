# Changelog

Все значимые изменения в этом проекте будут документированы в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и этот проект придерживается [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [2025-09-22] - Улучшения отслеживания сообщений и сессий

**Добавлено:**

- Поле `bot_id` в таблицу `food_analysis` с уникальным ограничением
- Поле `bot_id` в таблицу `message_relationships` с обновленным первичным ключом
- Миграция `20250922220001_add_bot_id_to_food_analysis.sql` (33 строки)
- Миграция `20250922220000_add_bot_id_to_message_relationships.sql` (28 строк)

**Изменено:**

- `userSessions.ts`: замена `single()` на `maybeSingle()` для улучшенной обработки ошибок (1 строка)
- `messageHandler.ts`: добавлен `bot_id` в данные сообщений (4 строки)
- `foodAnalysis.ts`: обновлена обработка `bot_id` в анализе еды (1 строка)
- `messageRelationships.ts`: добавлена логика поиска по `bot_id` с fallback на старый идентификатор (14 строк)
- `Database.ts`: добавлено поле `bot_id` в интерфейсы (1 строка)
- `index.ts`: обновлено логирование для использования ID бота вместо имени (2 строки)
- `onboarding.ts`: улучшены инструкции для пользователей по открытию приложения (1 строка)

## [2025-09-21] - Профили пользователей и сессии

**Добавлено:**

- Функции `upsertUserProfile()`, `getUserProfile()` в `userProfile.ts` (68 строк)
- Поля профиля: `height_cm`, `weight_kg`, `gender`, `birth_year`, `activity_level` в `Database.ts`
- Функции `upsertUserSession()`, `getUserSession()`, `deleteUserSession()` в `userSessions.ts` (80 строк)
- Интерфейс `UserSession` в `UserSession.ts` (13 строк)
- Миграция `20250920220000_create_user_sessions.sql` с таблицей `user_sessions` (19 строк)
- Миграция `20250920214544_remove_target_fields_from_user_profiles.sql` (49 строк)
- Файлы `CHANGELOG.md` (163 строки) и `LICENSE` (21 строка)
- Функция `getUserCalculations()` в `userProfile.ts` для расчета ИМТ, целевых калорий и макронутриентов (161 строка)
- Интерфейс `UserCalculations` в `Database.ts` с полями: `bmi`, `target_calories`, `target_protein_g`, `target_fat_g`, `target_carbs_g`
- Модуль онбординга `src/bot/onboarding.ts` (99 строк)

**Изменено:**

- `messageHandler.ts`: добавлена обработка команд `/set_profile` и `/profile` (141 строка)
- `userProfile.ts`: расширены функции работы с профилями (161 строка добавлена)
- `Database.ts`: добавлены поля для профилей пользователей (13 строк)
- `messageHandler.ts`: добавлен текст "Чтобы начать анализ, пожалуйста, пришлите фотографию блюда или опишите его текстом :)" в сообщение профиля (4 строки)
- `messageHandler.ts`: рефакторинг обработки сообщений с выделением логики онбординга (89 строк изменений)
- `README.md`: обновлена продолжительность пробного периода с 3 до 5 дней (1 строка)

**Удалено:**

- Устаревшие миграции: `20240322000000_create_users_table.sql`, `20240323000000_create_user_profiles.sql`, `20240323000001_fix_user_profiles.sql`, `20240324000000_add_profile_fields.sql`, `20240325000000_create_payment_system.sql`, `20240324000000_message_relationships_policies.sql`, `20240321000000_create_food_analysis.sql`
- Поля `target_*` из таблицы `user_profiles`

## [2025-09-20] - Конфигурация и настройка

**Добавлено:**

- Файл `.vscode/extensions.json` с настройками форматирования
- Файл `.vscode/settings.json` с настройками TypeScript
- Файл `supabase/.gitignore` (8 строк)
- Расширенные настройки в `config.toml` (90 строк)

**Изменено:**

- `.vscode/extensions.json`: обновлены расширения для форматирования (4 строки)
- `.vscode/settings.json`: добавлен форматтер TypeScript по умолчанию (8 строк)
- `config.toml`: добавлены настройки миграций БД и ограничений сети

**Удалено:**

- Файл `supabase/functions/deepseek-bot/deno.lock` (108 строк)

## [2025-09-18] - Рефакторинг архитектуры бота

**Добавлено:**

- Файл `src/bot/botFactory.ts` (28 строк) с фабрикой ботов
- Файл `src/bot/messageHandler.ts` (547 строк) с обработчиками сообщений
- Файл `src/config/botConfig.ts` (41 строка) с конфигурацией ботов
- Скрипт `scripts/setup_webhooks.sh` (15 строк)

**Изменено:**

- `index.ts`: рефакторинг с 630 строк до упрощенной структуры (699 строк добавлено, 573 строки удалено)
- `README.md`: обновлена документация по структуре бота (5 строк)
- `subscriptionHandlers.ts`: обновлена обработка подписок (6 строк)

## [2025-09-11] - Подписки и платежи

**Добавлено:**

- Команда `/subscription_test` для тестирования подписок
- Inline кнопки для активации планов подписки
- Функция `getUserByTelegramId()` для поиска пользователей
- Обработка callback запросов для пробных и платных подписок

**Изменено:**

- `index.ts`: добавлена команда `/subscription_test` (56 строк добавлено)
- `subscriptionHandlers.ts`: улучшена обработка ошибок при получении планов (5 строк)
- `foodAnalysis.ts`: улучшена обработка ошибок при вставке данных (18 строк)
- `subscriptions.ts`: улучшена обработка ошибок при получении планов (30 строк)
- `upsertUser.ts`: добавлена функция поиска пользователей (19 строк)
- `Database.ts`: добавлены новые интерфейсы (14 строк)

## [2025-09-05] - Улучшения локализации

**Добавлено:**

- Файл `src/utils/declension.ts` с утилитой склонения русских слов (51 строка)

**Изменено:**

- `index.ts`: интеграция утилиты склонения в сообщения подписок (6 строк)
- `subscriptionHandlers.ts`: обновлена формулировка продолжительности в сообщениях планов (6 строк)
- Сообщения планов подписки: обновлена формулировка продолжительности
- Описания счетов для пробных подписок

## [2025-09-04] - Ограничения пользователей

**Добавлено:**

- Функция `checkUserLimits()` в `userLimits.ts` (85 строк)
- Логика проверки лимитов на основе статуса подписки
- Ограничения ежедневного анализа для бесплатных пользователей

**Изменено:**

- `index.ts`: добавлена функция проверки лимитов пользователей (103 строки)
- Приветственные сообщения: добавлена персонализированная информация
- Сообщения об ограничениях: улучшена ясность для пользователей

## [2025-09-03] - Рефакторинг и документация

**Добавлено:**

- Файл `general.mdc` с правилами проекта (12 строк)
- Функция `processSuccessfulPayment()` в `processSuccessfulPayment.ts` (112 строк)
- Переменная окружения `YOOKASSA_PROVIDER_TOKEN`

**Изменено:**

- `index.ts`: упрощены инструкции для отправки изображений еды (1 строка)
- `index.ts`: рефакторинг обработки платежей (88 строк удалено, 112 строк добавлено)
- `README.md`: обновлена документация по структуре проекта (19 строк)
- Лимиты анализа для бесплатных пользователей

**Удалено:**

- Ненужные формулировки в подсказках для изображений

## [2025-09-01] - Начальная структура проекта

**Добавлено:**

- Базовая структура проекта Deepseek Bot
- Функции анализа еды с AI в `src/ai/`
- Утилиты для обработки изображений в `src/utils/`
- Интерфейсы БД в `src/interfaces/`
- Управление премиум статусом пользователей
- Функции подписок в `subscriptions.ts` (12 строк)
- Обработчики подписок в `subscriptionHandlers.ts` (84 строки)
- Интерфейсы для платежей в `Database.ts` (11 строк)

**Изменено:**

- `index.ts`: добавлена функциональность подписок (211 строк)
- Реорганизована структура файлов: AI и БД функции в отдельные директории
- `README.md`: добавлена документация по премиум функциям (38 строк)

## [2025-08-31] - Система платежей и анализ еды

**Добавлено:**

- Миграция `20240325000000_create_payment_system.sql` с таблицами подписок и платежей (97 строк)
- Функции `insertFoodAnalysis()`, `upsertFoodAnalysis()` в `foodAnalysis.ts` (47 строк)
- Функции `insertMessageRelationship()`, `getBotMessageId()` в `messageRelationships.ts` (28 строк)
- Интерфейсы для анализа еды и отношений сообщений в `Database.ts` (27 строк)
- Утилита `getImageUrlFromTelegram.ts` для получения URL изображений (17 строк)
- Скрипты развертывания: `deploy.sh`, `run.sh`, `set_env.sh`

**Изменено:**

- `index.ts`: рефакторинг обработки сообщений (75 строк изменено)
- `handleFoodImage.ts`: упрощена обработка изображений (16 строк изменено)
- `README.md`: обновлена документация проекта (197 строк)

**Удалено:**

- Ненужные файлы из `telegram-bot` функции (39 строк)

## [2025-08-31] - Профили пользователей

**Добавлено:**

- Миграция `20240324000000_add_profile_fields.sql` с полями профиля (76 строк)
- Миграция `20240323000000_create_user_profiles.sql` с таблицей профилей (102 строки)
- Миграция `20240323000001_fix_user_profiles.sql` с исправлениями (74 строки)

## [2025-08-27] - Управление пользователями и анализ еды

**Добавлено:**

- Миграция `20240322000000_create_users_table.sql` с таблицей пользователей (36 строк)
- Функция `upsertUser()` для управления пользователями (26 строк)
- Утилита `selectOptimalPhoto.ts` для выбора оптимального размера фото (38 строк)
- Интерфейс `FoodAnalysis` в `FoodAnalysis.ts` (14 строк)
- Утилита `formatFoodAnalysisMessage.ts` для форматирования сообщений (20 строк)
- Функция `handleFoodImage()` для анализа изображений еды (97 строк)

**Изменено:**

- `index.ts`: добавлена обработка пользователей и анализ еды (7 строк)
- `index.ts`: рефакторинг обработки сообщений (323 строки изменено)
- `handleFoodImage.ts`: улучшена структура ответа анализа (200 строк изменено)
- `prompts/foodImagePrompt.ts`: обновлены промпты для анализа (28 строк)

**Удалено:**

- Функция `handleCalculateFood()` и связанные промпты (31 строка)
- Функция `handleGiftSuggestion()` для предложения подарков (38 строк)

## [2025-06-05] - Улучшения обработки изображений

**Изменено:**

- `index.ts`: обновлен порог выбора размера фото с 640 до 320 (19 строк)
- `handleFoodImage.ts`: улучшена обработка JSON ответов (6 строк)
- `prompts/foodImagePrompt.ts`: уточнены требования к формату ответа (5 строк)

## [2025-06-04] - Оптимизация обработки изображений

**Изменено:**

- `handleFoodImage.ts`: упрощена обработка изображений с использованием URL вместо base64 (9 строк)

## [2025-06-02] - Система анализа еды

**Добавлено:**

- Миграция `20240321000000_create_food_analysis.sql` с таблицей анализа еды (40 строк)
- Миграция `20240320000000_message_relationships_policies.sql` с политиками безопасности (18 строк)
- Функции хранения данных анализа еды в `index.ts` (210 строк)

**Изменено:**

- `index.ts`: добавлено хранение данных анализа еды (193 строки)
- `handleFoodImage.ts`: улучшена структура ответа анализа (200 строк)
- `prompts/foodImagePrompt.ts`: обновлены промпты (43 строки)
- `deploy.sh`: обновлен скрипт развертывания (1 строка)

**Удалено:**

- Функциональность предложения подарков из приветственного сообщения (5 строк)

## [2025-06-01] - Базовая функциональность

**Добавлено:**

- Базовая структура Deepseek Bot
- Функции анализа еды по тексту и изображениям
- Интеграция с Telegram API
- Базовая обработка сообщений

**Изменено:**

- `README.md`: обновлена документация (240 строк)
- `handleFoodImage.ts`: добавлена обработка изображений еды (97 строк)
- `index.ts`: улучшена обработка сообщений (62 строки)

## [2025-04-20] - Улучшения анализа еды

**Изменено:**

- `handleCalculateFood.ts`: улучшен формат ответа анализа еды (37 строк)

## [2025-04-19] - Начальная настройка проекта

**Добавлено:**

- Базовая конфигурация Supabase
- Начальная структура проекта
- Файлы конфигурации VSCode
- Базовые скрипты развертывания

**Изменено:**

- `README.md`: добавлена документация проекта (97 строк)
- `config.toml`: настройка Supabase (11 строк)
- `.gitignore`: обновлены правила игнорирования (2 строки)

**Удалено:**

- Временные файлы и устаревшие ветки

---

## Легенда

- **Добавлено** - для новых функций
- **Изменено** - для изменений в существующей функциональности
- **Устарело** - для функций, которые скоро будут удалены
- **Удалено** - для удаленных функций
- **Исправлено** - для исправления ошибок
- **Безопасность** - для приглашения пользователей обновить в случае уязвимостей
