# Changelog

Все значимые изменения в этом проекте будут документированы в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и этот проект придерживается [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [2025-11-09] - Отслеживание воды, физической активности, стриков и обратная связь

**Добавлено:**

- Edge Function `water-intake-crud` для управления записями о потреблении воды с поддержкой CRUD операций (471 строка, включает README с примерами использования)
- Edge Function `load-water-intakes` для получения записей о потреблении воды с пагинацией и сортировкой (203 строки, включает README с документацией API)
- Модуль `waterIntake.ts` для записи потребления воды в базу данных (36 строк)
- Функция `insertWaterIntake()` для записи потребления воды (пару глотков или стакан)
- Inline-кнопки для записи потребления воды в Telegram боте ("Пару глотков" и "Стакан")
- Локализованные сообщения о потреблении воды на английском и русском языках
- Логирование события `water_intake_recorded` для аналитики потребления воды
- Статистика потребления воды в `load-user-stats`: общее потребление, общее количество в миллилитрах, среднее дневное потребление
- Edge Function `get-physical-activities` для получения записей о физической активности с пагинацией, группировкой по дням/неделям/месяцам и фильтрацией по датам (246 строк, включает README с примерами использования)
- Edge Function `delete-physical-activity` для удаления записей о физической активности с валидацией прав пользователя (192 строки, включает README с документацией API)
- Модуль `physicalActivity.ts` для управления записями о физической активности (64 строки)
- Функции `insertPhysicalActivity()` и `upsertPhysicalActivity()` для работы с физической активностью
- Поддержка анализа физической активности в боте (текст и изображения) с расчётом калорий
- Интерфейс `PhysicalActivityData` в `Database.ts` для работы с данными физической активности
- Локализованные сообщения о физической активности на английском и русском языках
- Логирование событий `physical_activity_text` и `physical_activity_image` для аналитики
- Функция `updateUserStreaks()` для автоматического обновления стриков пользователя на основе ежедневных анализов еды (195 строк)
- Поля `current_streak` и `longest_streak` в статистике пользователя (`load-user-stats`)
- Inline-кнопки "Like" и "Dislike" для обратной связи по анализу еды в Telegram боте
- Логирование событий обратной связи (`food_analysis_feedback`) для аналитики
- Локализованные сообщения об обратной связи на английском и русском языках
- Edge Function `load-daily-calories` для получения дневных калорий пользователя с пагинацией на основе курсора (включает README с примерами использования)
- Функция `hasRecentFoodTracking()` для проверки недавнего отслеживания еды (в течение 30 минут) для улучшения логики напоминаний

**Изменено:**

- `messageHandler.ts`: добавлена обработка inline-кнопок для записи потребления воды (пару глотков или стакан)
- `messageHandler.ts`: добавлена обработка обратной связи по анализу еды через inline-кнопки "Like" и "Dislike"
- `handleFoodImageAnalysis.ts`: добавлена поддержка анализа физической активности по изображениям с сохранением в базу данных
- `handleFoodTextAnalysis.ts`: добавлена поддержка анализа физической активности по тексту с сохранением в базу данных
- `messageHandler.ts`: добавлена поддержка анализа физической активности при редактировании сообщений
- `handleFoodImageAnalysis.ts`: добавлен вызов `updateUserStreaks()` после успешного анализа еды для обновления стриков
- `handleFoodTextAnalysis.ts`: добавлен вызов `updateUserStreaks()` после успешного анализа еды для обновления стриков
- `messageHandler.ts`: добавлен вызов `updateUserStreaks()` после успешного анализа еды для обновления стриков
- `load-user-stats/index.ts`: добавлена статистика потребления воды (общее потребление, общее количество в миллилитрах, среднее дневное потребление)
- `load-user-stats/index.ts`: добавлены поля `current_streak` и `longest_streak` в ответ API
- `load-user-stats/README.md`: обновлена документация с информацией о статистике воды и стриках пользователя
- `load-daily-calories/index.ts`: обновлён формат дат на ISO 8601 для обеспечения консистентности
- `load-daily-calories/README.md`: обновлена документация с примерами использования ISO 8601 формата дат
- `foodAnalysis.ts`: рефакторинг функций анализа еды для упрощения обновления стриков (удалены ненужные условные проверки)
- `foodAnalysis.ts`: улучшено логирование в функции `updateUserStreaks()` для лучшего отслеживания обновлений стриков
- `reminders.ts`: улучшена функция `shouldSendReminder()` с проверкой недавнего отслеживания еды (в течение 30 минут) для предотвращения отправки напоминаний, если пользователь недавно записал еду
- `reminders.ts`: обновлена функция `processReminders()` для обновления `last_sent_at` даже когда напоминания пропускаются, улучшая пользовательский опыт и точность отслеживания
- `Database.ts`: добавлен интерфейс `PhysicalActivityData` для работы с данными физической активности

**Исправлено:**

- Улучшена логика напоминаний с учётом недавнего отслеживания еды для более релевантных уведомлений
- Улучшена обработка обновления стриков пользователя с оптимизацией проверок и логирования

## [2025-11-08] - Напоминания, аналитика и активация пробного периода через промокоды

**Добавлено:**

- Edge Function `log-event` для логирования аналитических событий из Telegram бота и веб-приложений с валидацией запросов и обработкой ошибок (133 строки, включает README с примерами использования)
- Edge Function `load-analytics` для получения аналитических данных, включая воронки конверсии, статистику использования и метрики подписок (328 строк, включает README с документацией API)
- Модуль `reminders.ts` для управления напоминаниями пользователей в базе данных (112 строк)
- Функция `createReminderIfNeeded()` для автоматического создания напоминаний о приёмах пищи после анализа еды
- Функция `hasUserReminders()` для проверки наличия напоминаний у пользователя
- Поле `used_promo` в интерфейс `User` для отслеживания использованных промо-кодов (массив промо-кодов)
- Модуль `analytics.ts` для логирования аналитических событий (73 строки)
- Документация `docs/analytics-events.md` с описанием всех аналитических событий (423 строки)
- Логирование событий: регистрация пользователей, завершение онбординга, выполнение команд, активация пробного периода, просмотр подписок, анализ еды (текст и изображения)
- Функция `isNightTime()` для проверки ночного времени (22:00 - 08:00) на основе часового пояса пользователя
- Проверка поля `created_at` в логике напоминаний для предотвращения отправки напоминаний, созданных после запланированного времени

**Изменено:**

- `send-reminders/index.ts`: добавлена проверка ночного времени для предотвращения отправки напоминаний о воде в ночное время (29 строк)
- `send-reminders/index.ts`: улучшена функция `shouldSendReminder()` с проверкой поля `created_at` для обеспечения отправки только напоминаний, созданных до времени напоминания в тот же день (13 строк)
- `handleFoodImageAnalysis.ts`: добавлена интеграция `createReminderIfNeeded()` для автоматического создания напоминаний после анализа изображений еды (4 строки)
- `handleFoodTextAnalysis.ts`: добавлена интеграция `createReminderIfNeeded()` для автоматического создания напоминаний после текстового анализа еды (4 строки)
- `handleCommands.ts`: добавлена логика активации пробного периода через промо-коды и логирование событий (36 строк изменено)
- `handleFoodTextAnalysis.ts`: добавлена проверка и активация пробного периода через промо-коды (49 строк изменено)
- `upsertUser.ts`: добавлена поддержка отслеживания использованных промо-кодов (105 строк изменено)
- `subscriptionHandlers.ts`: улучшена обработка активации пробного периода через промо-коды с обновлённой локализацией сообщений (77 строк изменено)
- `processSuccessfulPayment.ts`: добавлено логирование события успешной оплаты (10 строк)
- `onboarding_simple.ts`: добавлено логирование события завершения онбординга (9 строк)
- `load-users/index.ts`: добавлено поле `used_promo` в ответ API (2 строки)
- `load-users/README.md`: обновлена документация с информацией о поле `used_promo` (4 строки)
- `Database.ts`: добавлено поле `used_promo` в интерфейс `User` (1 строка)

**Исправлено:**

- Улучшена логика отправки напоминаний с учётом времени создания и ночного времени для лучшего пользовательского опыта
- Улучшена обработка активации пробного периода через промо-коды с правильным отслеживанием использованных кодов

## [2025-11-07] - Рефакторинг обработчиков сообщений и функциональность поддержки

**Добавлено:**

- Модуль `handleCommands.ts` для обработки команд пользователей (`/start`, `/set_profile`, `/get_profile`, `/help`, `/test_support`, `/stop_support` и др.) (252 строки)
- Модуль `handleUserSessions.ts` для управления сессиями пользователей и настройки профиля, включая обработку режима поддержки (381 строка)
- Модуль `handleFoodImageAnalysis.ts` для анализа изображений еды с проверкой лимитов пользователя (138 строк)
- Модуль `handleFoodTextAnalysis.ts` для анализа текстовых описаний еды с проверкой лимитов пользователя (150 строк)
- Модуль `handleSupportDiscussionMessages.ts` для обработки сообщений из групп обсуждения поддержки (153 строки)
- Модуль `supportThreads.ts` для управления тредами поддержки (создание и получение постов поддержки) (155 строк)
- Функции `getOrCreateSupportThread()` и `getSupportThread()` для работы с тредами поддержки
- Поле `support_mode` в интерфейс `UserSession` для управления режимом поддержки
- Поля `supportChannelId` и `supportDiscussionGroupId` в конфигурацию бота (`BotConfig`) для работы с каналами и группами поддержки
- Команды `/test_support` и `/stop_support` для управления режимом поддержки пользователей
- Улучшенное логирование для отладки и мониторинга (детальное логирование для всех типов чатов, включая приватные и групповые)

**Изменено:**

- `messageHandler.ts`: рефакторинг с разделением обработки на отдельные модули для улучшения организации кода и читаемости
- `messageHandler.ts`: добавлена обработка сообщений из групп обсуждения поддержки с пересылкой сообщений от агентов поддержки пользователям
- `messageHandler.ts`: ограничена обработка сообщений только приватными чатами для улучшения функциональности бота
- `messageHandler.ts`: улучшено логирование для всех типов чатов (приватные, группы, каналы) с детальной информацией о пользователях и типах чатов
- `handleUserSessions.ts`: добавлена обработка сообщений пользователей в режиме поддержки с пересылкой в группы обсуждения
- `handleUserSessions.ts`: улучшена обработка медиа-файлов и ответов в режиме поддержки
- `supportThreads.ts`: обновлена терминология для работы с постами поддержки (post_id вместо thread_id)
- `onboarding_simple.ts`: добавлены инструкции по промо-кодам в онбординге на английском и русском языках
- `botConfig.ts`: добавлены опциональные поля для конфигурации каналов и групп поддержки

**Исправлено:**

- Улучшена обработка сообщений в режиме поддержки с правильным сохранением ID сообщений
- Улучшена обработка медиа-файлов и ответов при пересылке сообщений из групп поддержки пользователям

## [2025-10-31] - Отслеживание источников трафика и улучшения статистики

**Добавлено:**

- Поле `traffic_source` в интерфейс `User` для отслеживания источника трафика пользователей
- Функция `updateUserTrafficSource()` для обновления источника трафика (устанавливается только если поле пустое)
- Поле `traffic_source` в интерфейс `DbUser` для работы с базой данных
- Массив `traffic_source` в статистике функции `load-stats` для агрегации пользователей по источникам трафика
- Count queries в функции `load-user-stats` для более точного подсчёта анализов (используются count запросы вместо длин массивов)

**Изменено:**

- `messageHandler`: добавлено извлечение и сохранение источника трафика из команды `/start` в приватных чатах
- `upsertUser`: добавлено обновление источника трафика пользователя при создании/обновлении
- `load-user-stats`: улучшена обработка ошибок при получении общего количества и количества изображений; обновлены расчёты статистики для использования count запросов вместо прямых длин массивов
- `load-stats`: добавлена статистика по источникам трафика в ответе API
- `load-users`: добавлено поле `traffic_source` в ответ API
- `scripts/deploy.sh`: рефакторинг для принятия имени функции как аргумента, что повышает гибкость развёртывания различных Supabase функций
- README документация для `load-stats` и `load-users`: обновлены примеры использования API с новым полем `traffic_source`

**Исправлено:**

- Улучшена точность статистики в `load-user-stats` за счёт использования count запросов вместо длин массивов

## [2025-10-30] - Подписки, лимиты и улучшения UX

**Добавлено:**

- Отдельный учёт лимитов для текстовых и фото-анализов в `userLimits`

**Изменено:**

- `messageHandler`: улучшены уведомления о лимитах анализа для бесплатных пользователей и добавлены предложения подписки с inline-кнопками
- `messageHandler`: рефактор обработки подписок — вынесено в `replyWithAvailableSubscriptions` для единой точки получения планов и форматирования сообщений
- `messageHandler`: улучшены тексты уведомлений по анализу изображений; добавлены локализованные сообщения о лимитах и остатках анализов (EN/RU)

**Удалено:**

- Убрано лишнее уведомление о пробной подписке в `activateTrialWithPromo`, если пробный период уже использован
- Удалено ненужное обновление сессии пользователя при обработке `/set_promo` в приватных чатах

## [2025-10-28] - Промокоды для пробного периода и локализация

**Добавлено:**

- Обработка промокодов для активации пробного периода в `messageHandler` и `subscriptionHandlers`
- Локализованные сообщения (EN/RU) для сценариев подписок (успех/ошибка) и выставления счетов

**Изменено:**

- `messageHandler`: уточнено уведомление при остатке 1 текстового анализа в сутки для лучшей осведомлённости и предложения апгрейда

## [2025-10-27] - Улучшения текстов напоминаний

**Изменено:**

- `send-reminders` (Edge Function): переработаны тексты напоминаний о воде и приёмах пищи (EN/RU) для большей ясности и вовлечённости

## [2025-10-26] - Расширение API функций и улучшения управления данными

**Добавлено:**

- Edge Function `get-food-analyses` для получения анализов еды пользователя с поддержкой пагинации, группировки по дням/неделям/месяцам и фильтрации по датам (255 строк)
- Edge Functions для веб-интерфейса Bakery UI: `load-users`, `load-analyses`, `load-profiles`, `load-stats` (989 строк)
- Edge Function `delete-food-analysis` для удаления записей анализа еды с валидацией и обработкой ошибок (включает README.md с документацией API)
- Edge Function `load-user-stats` для получения статистики пользователя с детальными расчетами (включает README.md с примерами использования)
- Edge Function `user-profiles-crud` для полного управления профилями пользователей с CRUD операциями
- Поле `image_url` в интерфейсе `FoodAnalysisData` для хранения URL изображений анализа еды
- Средние дневные значения питательных веществ в `load-user-stats`: `avg_daily_calories`, `avg_daily_protein`, `avg_daily_carbs`, `avg_daily_fats`
- Расчет активных дней (`active_days`) в статистике пользователя
- Поддержка CORS preflight запросов во всех новых Edge Functions
- Стандартизированная обработка ошибок и пагинация во всех API функциях
- Подробная документация API в `supabase/functions/README.md` (440 строк)
- Скрипт `scripts/fix_connection.sh` для исправления проблем с подключением к Supabase (5 строк)
- Поле `promo` в интерфейсе `User` для поддержки промо-кодов в API ответах

**Изменено:**

- `supabase/functions/README.md`: добавлена подробная документация для всех новых API функций
- `load-users/index.ts`: добавлена поддержка поля `promo` в ответах API (2 строки)
- `get-food-analyses/index.ts`: добавлено поле `image_url` в ответ API для улучшения пользовательского опыта
- `messageHandler.ts`: обновлена интеграция получения URL изображений для данных анализа еды
- `load-user-stats/index.ts`: расширена функциональность с добавлением средних значений и активных дней
- Интерфейс `FoodAnalysisData`: добавлено опциональное поле `image_url` для хранения URL изображений
- `foodImagePrompt.ts`: улучшены инструкции для обработки весов ингредиентов, указанных пользователем (обновлен формат JSON ответа)

**Исправлено:**

- Улучшена обработка ошибок во всех новых API функциях
- Стандартизирована обработка CORS preflight запросов
- Улучшена валидация данных в функциях удаления и обновления

## [2025-10-19] - Улучшения анализа изображений еды

**Добавлено:**

- Обновленный промпт `foodImagePrompt.ts` с приоритетом данных упаковки для расчетов (26 строк)
- Улучшенная обработка числовых полей в JSON ответах анализа еды (15 строк добавлено, 11 строк удалено)
- Поддержка разрешения изображений 1024x1024 в `selectOptimalPhoto.ts` (14 строк)
- Динамические языковые промпты в `handleFoodImage.ts` (14 строк)
- Локализованные сообщения об ошибках в `en.ts` (21 строка) и `ru.ts` (20 строк)

**Изменено:**

- `foodImagePrompt.ts`: добавлены инструкции по использованию данных упаковки и уточнен формат JSON (11 строк)
- `messageHandler.ts`: обновлена обработка размера фото для целевого разрешения 1024x1024 (2 строки)
- `selectOptimalPhoto.ts`: изменена логика выбора оптимального размера фото (14 строк)
- `handleFoodImage.ts`: добавлена поддержка динамических языковых промптов (14 строк)
- `formatFoodAnalysisMessage.ts`: добавлена поддержка языковых кодов (34 строки)
- `messageHandler.ts`: обновлена обработка изображений еды с интернационализацией (8 строк)

## [2025-10-18] - Интернационализация и промо-коды

**Добавлено:**

- Система интернационализации (i18n) с поддержкой английского и русского языков (683 строки)
- Файлы локализации `src/locales/en.ts` (159 строк) и `src/locales/ru.ts` (165 строк)
- Утилита `src/utils/i18n.ts` для управления переводами (94 строки)
- Функциональность промо-кодов для пользователей (59 строк)
- Поле `promo` в интерфейсе `UserSession` для хранения промо-кода пользователя
- Поле `available_promo_codes` в интерфейсе `SubscriptionPlan` для фильтрации планов
- Файл `.env.example` с конфигурацией переменных окружения (14 строк)
- Документация `docs/src.md` с описанием структуры проекта (37 строк)
- Сообщения онбординга с промо-кодами на английском и русском языках (6 строк)

**Изменено:**

- `messageHandler.ts`: добавлена поддержка интернационализации и промо-кодов (246 строк изменено)
- `onboarding.ts`: обновлен онбординг с поддержкой языков и промо-кодов (73 строки изменено)
- `upsertUser.ts`: добавлена поддержка языковых предпочтений и промо-кодов (47 строк изменено)
- `subscriptions.ts`: добавлена фильтрация планов по промо-кодам пользователя (53 строки изменено)
- `Database.ts`: добавлены поля `language` и `promo` в интерфейсы пользователей
- `README.md`: обновлена документация с ссылкой на `.env.example` (10 строк изменено)
- `docs/src.md`: создана подробная документация структуры проекта

**Удалено:**

- Миграция `20240321000000_initial_schema.sql` (469 строк)
- Миграция `20250920214544_remove_target_fields_from_user_profiles.sql` (49 строк)
- Миграция `20250920220000_create_user_sessions.sql` (19 строк)
- Миграция `20250922220000_add_bot_id_to_message_relationships.sql` (28 строк)
- Миграция `20250922220001_add_bot_id_to_food_analysis.sql` (33 строк)
- Скрипты из `supabase/functions/deepseek-bot/scripts/` перемещены в корневую папку `scripts/`

## [2025-10-05] - Дополнительные улучшения и исправления

**Добавлено:**

- Улучшенная обработка ошибок в `userSessions.ts` с использованием `maybeSingle()` (1 строка)
- Логирование с использованием ID бота вместо имени в `index.ts` (2 строки)
- Обновленная документация в `README.md` с информацией о скриптах и миграциях (5 строк)

**Изменено:**

- `messageHandler.ts`: уточнен текст кнопок подписки для улучшения ясности (1 строка)
- `onboarding.ts`: исправлена формулировка в сообщении онбординга (1 строка)
- `messageHandler.ts`: добавлен `bot_id` в данные сообщений для улучшения отслеживания (4 строки)
- `foodAnalysis.ts`: обновлена обработка `bot_id` в анализе еды (1 строка)
- `messageRelationships.ts`: улучшена логика поиска сообщений с fallback на старый идентификатор (14 строк)
- `Database.ts`: добавлено поле `bot_id` в интерфейсы (1 строка)

**Исправлено:**

- Улучшена обработка ошибок при получении сессий пользователей
- Исправлена формулировка в сообщениях онбординга
- Улучшена ясность текста кнопок подписки

## [2025-09-22] - Улучшения отслеживания сообщений и сессий

**Добавлено:**

- Поле `bot_id` в таблицу `food_analysis` с уникальным ограничением
- Поле `bot_id` в таблицу `message_relationships` с обновленным первичным ключом
- Миграция `20250922220001_add_bot_id_to_food_analysis.sql` (33 строки)
- Миграция `20250922220000_add_bot_id_to_message_relationships.sql` (28 строк)

**Изменено:**

- `userSessions.ts`: замена `single()` на `maybeSingle()` для улучшенной обработки ошибок (1 строка)
- `messageHandler.ts`: добавлен `bot_id` в данные сообщений (4 строки)
- `foodAnalysis.ts`: обновлена обработка `bot_id` в анализе еды (1 строка)
- `messageRelationships.ts`: добавлена логика поиска по `bot_id` с fallback на старый идентификатор (14 строк)
- `Database.ts`: добавлено поле `bot_id` в интерфейсы (1 строка)
- `index.ts`: обновлено логирование для использования ID бота вместо имени (2 строки)
- `onboarding.ts`: улучшены инструкции для пользователей по открытию приложения (1 строка)

## [2025-09-21] - Профили пользователей и сессии

**Добавлено:**

- Функции `upsertUserProfile()`, `getUserProfile()` в `userProfile.ts` (68 строк)
- Поля профиля: `height_cm`, `weight_kg`, `gender`, `birth_year`, `activity_level` в `Database.ts`
- Функции `upsertUserSession()`, `getUserSession()`, `deleteUserSession()` в `userSessions.ts` (80 строк)
- Интерфейс `UserSession` в `UserSession.ts` (13 строк)
- Миграция `20250920220000_create_user_sessions.sql` с таблицей `user_sessions` (19 строк)
- Миграция `20250920214544_remove_target_fields_from_user_profiles.sql` (49 строк)
- Файлы `CHANGELOG.md` (163 строки) и `LICENSE` (21 строка)
- Функция `getUserCalculations()` в `userProfile.ts` для расчета ИМТ, целевых калорий и макронутриентов (161 строка)
- Интерфейс `UserCalculations` в `Database.ts` с полями: `bmi`, `target_calories`, `target_protein_g`, `target_fat_g`, `target_carbs_g`
- Модуль онбординга `src/bot/onboarding.ts` (99 строк)

**Изменено:**

- `messageHandler.ts`: добавлена обработка команд `/set_profile` и `/profile` (141 строка)
- `userProfile.ts`: расширены функции работы с профилями (161 строка добавлена)
- `Database.ts`: добавлены поля для профилей пользователей (13 строк)
- `messageHandler.ts`: добавлен текст "Чтобы начать анализ, пожалуйста, пришлите фотографию блюда или опишите его текстом :)" в сообщение профиля (4 строки)
- `messageHandler.ts`: рефакторинг обработки сообщений с выделением логики онбординга (89 строк изменений)
- `README.md`: обновлена продолжительность пробного периода с 3 до 5 дней (1 строка)

**Удалено:**

- Устаревшие миграции: `20240322000000_create_users_table.sql`, `20240323000000_create_user_profiles.sql`, `20240323000001_fix_user_profiles.sql`, `20240324000000_add_profile_fields.sql`, `20240325000000_create_payment_system.sql`, `20240324000000_message_relationships_policies.sql`, `20240321000000_create_food_analysis.sql`
- Поля `target_*` из таблицы `user_profiles`

## [2025-09-20] - Конфигурация и настройка

**Добавлено:**

- Файл `.vscode/extensions.json` с настройками форматирования
- Файл `.vscode/settings.json` с настройками TypeScript
- Файл `supabase/.gitignore` (8 строк)
- Расширенные настройки в `config.toml` (90 строк)

**Изменено:**

- `.vscode/extensions.json`: обновлены расширения для форматирования (4 строки)
- `.vscode/settings.json`: добавлен форматтер TypeScript по умолчанию (8 строк)
- `config.toml`: добавлены настройки миграций БД и ограничений сети

**Удалено:**

- Файл `supabase/functions/deepseek-bot/deno.lock` (108 строк)

## [2025-09-18] - Рефакторинг архитектуры бота

**Добавлено:**

- Файл `src/bot/botFactory.ts` (28 строк) с фабрикой ботов
- Файл `src/bot/messageHandler.ts` (547 строк) с обработчиками сообщений
- Файл `src/config/botConfig.ts` (41 строка) с конфигурацией ботов
- Скрипт `scripts/setup_webhooks.sh` (15 строк)

**Изменено:**

- `index.ts`: рефакторинг с 630 строк до упрощенной структуры (699 строк добавлено, 573 строки удалено)
- `README.md`: обновлена документация по структуре бота (5 строк)
- `subscriptionHandlers.ts`: обновлена обработка подписок (6 строк)

## [2025-09-11] - Подписки и платежи

**Добавлено:**

- Команда `/subscription_test` для тестирования подписок
- Inline кнопки для активации планов подписки
- Функция `getUserByTelegramId()` для поиска пользователей
- Обработка callback запросов для пробных и платных подписок

**Изменено:**

- `index.ts`: добавлена команда `/subscription_test` (56 строк добавлено)
- `subscriptionHandlers.ts`: улучшена обработка ошибок при получении планов (5 строк)
- `foodAnalysis.ts`: улучшена обработка ошибок при вставке данных (18 строк)
- `subscriptions.ts`: улучшена обработка ошибок при получении планов (30 строк)
- `upsertUser.ts`: добавлена функция поиска пользователей (19 строк)
- `Database.ts`: добавлены новые интерфейсы (14 строк)

## [2025-09-05] - Улучшения локализации

**Добавлено:**

- Файл `src/utils/declension.ts` с утилитой склонения русских слов (51 строка)

**Изменено:**

- `index.ts`: интеграция утилиты склонения в сообщения подписок (6 строк)
- `subscriptionHandlers.ts`: обновлена формулировка продолжительности в сообщениях планов (6 строк)
- Сообщения планов подписки: обновлена формулировка продолжительности
- Описания счетов для пробных подписок

## [2025-09-04] - Ограничения пользователей

**Добавлено:**

- Функция `checkUserLimits()` в `userLimits.ts` (85 строк)
- Логика проверки лимитов на основе статуса подписки
- Ограничения ежедневного анализа для бесплатных пользователей

**Изменено:**

- `index.ts`: добавлена функция проверки лимитов пользователей (103 строки)
- Приветственные сообщения: добавлена персонализированная информация
- Сообщения об ограничениях: улучшена ясность для пользователей

## [2025-09-03] - Рефакторинг и документация

**Добавлено:**

- Файл `general.mdc` с правилами проекта (12 строк)
- Функция `processSuccessfulPayment()` в `processSuccessfulPayment.ts` (112 строк)
- Переменная окружения `YOOKASSA_PROVIDER_TOKEN`

**Изменено:**

- `index.ts`: упрощены инструкции для отправки изображений еды (1 строка)
- `index.ts`: рефакторинг обработки платежей (88 строк удалено, 112 строк добавлено)
- `README.md`: обновлена документация по структуре проекта (19 строк)
- Лимиты анализа для бесплатных пользователей

**Удалено:**

- Ненужные формулировки в подсказках для изображений

## [2025-09-01] - Начальная структура проекта

**Добавлено:**

- Базовая структура проекта Deepseek Bot
- Функции анализа еды с AI в `src/ai/`
- Утилиты для обработки изображений в `src/utils/`
- Интерфейсы БД в `src/interfaces/`
- Управление премиум статусом пользователей
- Функции подписок в `subscriptions.ts` (12 строк)
- Обработчики подписок в `subscriptionHandlers.ts` (84 строки)
- Интерфейсы для платежей в `Database.ts` (11 строк)

**Изменено:**

- `index.ts`: добавлена функциональность подписок (211 строк)
- Реорганизована структура файлов: AI и БД функции в отдельные директории
- `README.md`: добавлена документация по премиум функциям (38 строк)

## [2025-08-31] - Система платежей и анализ еды

**Добавлено:**

- Миграция `20240325000000_create_payment_system.sql` с таблицами подписок и платежей (97 строк)
- Функции `insertFoodAnalysis()`, `upsertFoodAnalysis()` в `foodAnalysis.ts` (47 строк)
- Функции `insertMessageRelationship()`, `getBotMessageId()` в `messageRelationships.ts` (28 строк)
- Интерфейсы для анализа еды и отношений сообщений в `Database.ts` (27 строк)
- Утилита `getImageUrlFromTelegram.ts` для получения URL изображений (17 строк)
- Скрипты развертывания: `deploy.sh`, `run.sh`, `set_env.sh`

**Изменено:**

- `index.ts`: рефакторинг обработки сообщений (75 строк изменено)
- `handleFoodImage.ts`: упрощена обработка изображений (16 строк изменено)
- `README.md`: обновлена документация проекта (197 строк)

**Удалено:**

- Ненужные файлы из `telegram-bot` функции (39 строк)

## [2025-08-31] - Профили пользователей

**Добавлено:**

- Миграция `20240324000000_add_profile_fields.sql` с полями профиля (76 строк)
- Миграция `20240323000000_create_user_profiles.sql` с таблицей профилей (102 строки)
- Миграция `20240323000001_fix_user_profiles.sql` с исправлениями (74 строки)

## [2025-08-27] - Управление пользователями и анализ еды

**Добавлено:**

- Миграция `20240322000000_create_users_table.sql` с таблицей пользователей (36 строк)
- Функция `upsertUser()` для управления пользователями (26 строк)
- Утилита `selectOptimalPhoto.ts` для выбора оптимального размера фото (38 строк)
- Интерфейс `FoodAnalysis` в `FoodAnalysis.ts` (14 строк)
- Утилита `formatFoodAnalysisMessage.ts` для форматирования сообщений (20 строк)
- Функция `handleFoodImage()` для анализа изображений еды (97 строк)

**Изменено:**

- `index.ts`: добавлена обработка пользователей и анализ еды (7 строк)
- `index.ts`: рефакторинг обработки сообщений (323 строки изменено)
- `handleFoodImage.ts`: улучшена структура ответа анализа (200 строк изменено)
- `prompts/foodImagePrompt.ts`: обновлены промпты для анализа (28 строк)

**Удалено:**

- Функция `handleCalculateFood()` и связанные промпты (31 строка)
- Функция `handleGiftSuggestion()` для предложения подарков (38 строк)

## [2025-06-05] - Улучшения обработки изображений

**Изменено:**

- `index.ts`: обновлен порог выбора размера фото с 640 до 320 (19 строк)
- `handleFoodImage.ts`: улучшена обработка JSON ответов (6 строк)
- `prompts/foodImagePrompt.ts`: уточнены требования к формату ответа (5 строк)

## [2025-06-04] - Оптимизация обработки изображений

**Изменено:**

- `handleFoodImage.ts`: упрощена обработка изображений с использованием URL вместо base64 (9 строк)

## [2025-06-02] - Система анализа еды

**Добавлено:**

- Миграция `20240321000000_create_food_analysis.sql` с таблицей анализа еды (40 строк)
- Миграция `20240320000000_message_relationships_policies.sql` с политиками безопасности (18 строк)
- Функции хранения данных анализа еды в `index.ts` (210 строк)

**Изменено:**

- `index.ts`: добавлено хранение данных анализа еды (193 строки)
- `handleFoodImage.ts`: улучшена структура ответа анализа (200 строк)
- `prompts/foodImagePrompt.ts`: обновлены промпты (43 строки)
- `deploy.sh`: обновлен скрипт развертывания (1 строка)

**Удалено:**

- Функциональность предложения подарков из приветственного сообщения (5 строк)

## [2025-06-01] - Базовая функциональность

**Добавлено:**

- Базовая структура Deepseek Bot
- Функции анализа еды по тексту и изображениям
- Интеграция с Telegram API
- Базовая обработка сообщений

**Изменено:**

- `README.md`: обновлена документация (240 строк)
- `handleFoodImage.ts`: добавлена обработка изображений еды (97 строк)
- `index.ts`: улучшена обработка сообщений (62 строки)

## [2025-04-20] - Улучшения анализа еды

**Изменено:**

- `handleCalculateFood.ts`: улучшен формат ответа анализа еды (37 строк)

## [2025-04-19] - Начальная настройка проекта

**Добавлено:**

- Базовая конфигурация Supabase
- Начальная структура проекта
- Файлы конфигурации VSCode
- Базовые скрипты развертывания

**Изменено:**

- `README.md`: добавлена документация проекта (97 строк)
- `config.toml`: настройка Supabase (11 строк)
- `.gitignore`: обновлены правила игнорирования (2 строки)

**Удалено:**

- Временные файлы и устаревшие ветки

---

## Легенда

- **Добавлено** - для новых функций
- **Изменено** - для изменений в существующей функциональности
- **Устарело** - для функций, которые скоро будут удалены
- **Удалено** - для удаленных функций
- **Исправлено** - для исправления ошибок
- **Безопасность** - для приглашения пользователей обновить в случае уязвимостей
