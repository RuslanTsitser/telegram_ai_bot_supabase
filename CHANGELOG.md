# Changelog

Все значимые изменения в этом проекте будут документированы в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и этот проект придерживается [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

**Добавлено:**

- Новый файл `src/bot/onboarding.ts` (99 строк) с модулем онбординга
- Функция `getUserCalculations()` в `userProfile.ts` для расчета ИМТ, целевых калорий и макронутриентов
- Интерфейс `UserCalculations` в `Database.ts` с полями: `bmi`, `target_calories`, `target_protein_g`, `target_fat_g`, `target_carbs_g`
- Функции управления сессиями: `upsertUserSession()`, `getUserSession()`, `deleteUserSession()` в `userSessions.ts`
- Интерфейс `UserSession` с полями: `id`, `user_id`, `session_data`, `created_at`, `updated_at`
- Миграция `20250920220000_create_user_sessions.sql` с таблицей `user_sessions`

**Изменено:**

- `messageHandler.ts`: добавлен текст "Чтобы начать анализ, пожалуйста, пришлите фотографию блюда или опишите его текстом :)" в сообщение профиля
- `messageHandler.ts`: рефакторинг обработки сообщений с выделением логики онбординга (89 строк изменений)
- `userProfile.ts`: добавлены функции расчета пользовательских метрик (161 строка добавлена)
- `Database.ts`: расширен интерфейс с новыми полями для расчетов (8 строк добавлено)

## [2025-09-21] - Профили пользователей и сессии

**Добавлено:**

- Функции `upsertUserProfile()`, `getUserProfile()` в `userProfile.ts` (68 строк)
- Поля профиля: `height_cm`, `weight_kg`, `gender`, `birth_year`, `activity_level` в `Database.ts`
- Функции `upsertUserSession()`, `getUserSession()`, `deleteUserSession()` в `userSessions.ts` (80 строк)
- Интерфейс `UserSession` в `UserSession.ts` (13 строк)
- Миграция `20250920220000_create_user_sessions.sql` с таблицей `user_sessions` (19 строк)
- Миграция `20250920214544_remove_target_fields_from_user_profiles.sql` (49 строк)

**Изменено:**

- `messageHandler.ts`: добавлена обработка команд `/set_profile` и `/profile` (141 строка)
- `userProfile.ts`: расширены функции работы с профилями (161 строка добавлена)
- `Database.ts`: добавлены поля для профилей пользователей (13 строк)

**Удалено:**

- Устаревшие миграции: `20240322000000_create_users_table.sql`, `20240323000000_create_user_profiles.sql`, `20240323000001_fix_user_profiles.sql`, `20240324000000_add_profile_fields.sql`, `20240325000000_create_payment_system.sql`, `20240324000000_message_relationships_policies.sql`, `20240321000000_create_food_analysis.sql`
- Поля `target_*` из таблицы `user_profiles`

## [2025-09-20] - Конфигурация и настройка

**Добавлено:**

- Файл `.vscode/extensions.json` с настройками форматирования
- Файл `.vscode/settings.json` с настройками TypeScript
- Файл `supabase/.gitignore` (8 строк)
- Расширенные настройки в `config.toml` (90 строк)

**Изменено:**

- `.vscode/extensions.json`: обновлены расширения для форматирования (4 строки)
- `.vscode/settings.json`: добавлен форматтер TypeScript по умолчанию (8 строк)
- `config.toml`: добавлены настройки миграций БД и ограничений сети

**Удалено:**

- Файл `supabase/functions/deepseek-bot/deno.lock` (108 строк)

## [2025-09-18] - Рефакторинг архитектуры бота

**Добавлено:**

- Файл `src/bot/botFactory.ts` (28 строк) с фабрикой ботов
- Файл `src/bot/messageHandler.ts` (547 строк) с обработчиками сообщений
- Файл `src/config/botConfig.ts` (41 строка) с конфигурацией ботов
- Скрипт `scripts/setup_webhooks.sh` (15 строк)

**Изменено:**

- `index.ts`: рефакторинг с 630 строк до упрощенной структуры
- `README.md`: обновлена документация по структуре бота (5 строк)
- `subscriptionHandlers.ts`: обновлена обработка подписок (6 строк)

## [2025-09-11] - Подписки и платежи

**Добавлено:**

- Команда `/subscription_test` для тестирования подписок
- Inline кнопки для активации планов подписки
- Функция `getUserByTelegramId()` для поиска пользователей
- Обработка callback запросов для пробных и платных подписок

**Изменено:**

- `subscriptionHandlers.ts`: улучшена обработка ошибок при получении планов
- `foodAnalysis.ts`: улучшена обработка ошибок при вставке данных
- `messageHandler.ts`: обновлена обработка callback запросов

## [2025-09-05] - Улучшения локализации

**Добавлено:**

- Файл `src/utils/declension.ts` с утилитой склонения русских слов

**Изменено:**

- Сообщения планов подписки: обновлена формулировка продолжительности
- Описания счетов для пробных подписок

## [2025-09-04] - Ограничения пользователей

**Добавлено:**

- Функция `checkUserLimits()` в `userLimits.ts`
- Логика проверки лимитов на основе статуса подписки
- Ограничения ежедневного анализа для бесплатных пользователей

**Изменено:**

- Приветственные сообщения: добавлена персонализированная информация
- Сообщения об ограничениях: улучшена ясность для пользователей

## [2025-09-03] - Рефакторинг и документация

**Добавлено:**

- Файл `general.mdc` с правилами проекта
- Функция `processSuccessfulPayment()` в `processSuccessfulPayment.ts`
- Переменная окружения `YOOKASSA_PROVIDER_TOKEN`

**Изменено:**

- `messageHandler.ts`: упрощены инструкции для отправки изображений еды
- `README.md`: обновлена документация по структуре проекта
- Лимиты анализа для бесплатных пользователей

**Удалено:**

- Ненужные формулировки в подсказках для изображений

## [2025-09-01] - Начальная структура проекта

**Добавлено:**

- Базовая структура проекта Deepseek Bot
- Функции анализа еды с AI в `src/ai/`
- Утилиты для обработки изображений в `src/utils/`
- Интерфейсы БД в `src/interfaces/`
- Управление премиум статусом пользователей

**Изменено:**

- Реорганизована структура файлов: AI и БД функции в отдельные директории
- `README.md`: добавлена документация по премиум функциям

---

## Легенда

- **Добавлено** - для новых функций
- **Изменено** - для изменений в существующей функциональности
- **Устарело** - для функций, которые скоро будут удалены
- **Удалено** - для удаленных функций
- **Исправлено** - для исправления ошибок
- **Безопасность** - для приглашения пользователей обновить в случае уязвимостей
